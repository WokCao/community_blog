<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title th:text="${post.title} + ' - Community Blog'">Post Title - Community Blog</title>
    <meta property="og:title" th:content="${post.title}">
    <meta property="og:description" th:content="${post.content}">
    <meta property="og:url" th:content="@{'/post/' + ${post.id}}">
    <meta property="og:type" content="article">

    <link th:href="@{/css/output.css}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script th:src="@{/js/tag-colors.js}" defer></script>
    <script th:src="@{/js/post-action.js}" defer></script>
    <script th:src="@{/js/comment-action.js}" defer></script>
    <script th:src="@{/js/notification.js}" defer></script>
    <script th:src="@{/js/follow.js}" defer></script>
    <script th:src="@{/js/sidebar.js}" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>

<body class="bg-gradient-to-br from-slate-50 to-indigo-50 min-h-screen">
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="max-w-5xl mx-auto px-4 py-10 space-y-10">
    <!-- âœ¨ Post Header -->
    <article class="bg-white rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
        <!-- Featured Image -->
        <div th:if="${post.thumbnailUrl}"
             class="relative h-96 overflow-hidden bg-gradient-to-br from-indigo-400 to-purple-500">
            <img th:src="${post.thumbnailUrl}" th:alt="${post.title}" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent"></div>
        </div>

        <div class="p-8 md:p-12">
            <!-- Topic / Tags -->
            <div class="mb-4 flex flex-wrap gap-2">
          <span th:each="tag : ${post.tags}"
                class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-1.5 rounded-full text-sm font-semibold shadow-lg transform hover:scale-105 transition-all">
            <i class="fas fa-tag mr-1"></i><span th:text="${tag}">tag</span>
          </span>
            </div>

            <!-- Title -->
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 leading-tight mb-6" th:text="${post.title}">Post
                Title</h1>

            <!-- Author -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between pb-8 mb-8 border-b border-gray-200">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <img th:src="${post.author.avatarUrl}" th:alt="${post.author.fullName}"
                         class="w-16 h-16 rounded-full border-4 border-indigo-100 shadow-md object-cover">
                    <div>
                        <a th:href="@{/users/{id}(id=${post.author.id})}"
                           class="font-semibold text-lg text-gray-800 hover:text-indigo-600 transition-colors"
                           th:text="${post.author.fullName}">Author</a>
                        <div class="flex items-center text-sm text-gray-500 space-x-2">
                            <span th:text="${#temporals.format(post.createdAt, 'MMM dd, yyyy')}">Date</span>
                            <span>â€¢</span>
                            <span>5 min read</span>
                        </div>
                    </div>
                </div>

                <button id="follow-btn"
                        class="px-6 py-2 rounded-xl font-semibold transition-all shadow-md"
                        th:classappend="${post.author.id == user?.id ? 'hidden' : (isFollowing ? 'bg-gray-200 text-gray-700 hover:bg-gray-300' : 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:from-indigo-700 hover:to-purple-700')}"
                        th:data-user-id="${post.author.id}" th:data-action="${isFollowing ? 'unfollow' : 'follow'}">
                    <i th:class="${isFollowing} ? 'fas fa-check mr-2' : 'fas fa-plus mr-2'"></i>
                    <span th:text="${isFollowing ? 'Following' : 'Follow'}"></span>
                </button>
            </div>

            <!-- Post Content -->
            <div class="prose prose-lg max-w-none text-gray-800 mb-10" th:utext="${post.content}"></div>

            <!-- Actions -->
            <div class="flex items-center justify-between py-6 border-y border-gray-200">
                <div class="flex space-x-4">
                    <form class="like-post-form inline" th:data-post-id="${post.id}">
                        <button type="submit"
                                class="flex items-center space-x-2 px-4 py-2 rounded-xl font-semibold transition-all"
                                th:classappend="${isPostLikedByUser} ? 'bg-red-50 text-red-600 hover:bg-red-100' : 'bg-gray-100 text-gray-700 hover:bg-red-50 hover:text-red-600'">
                            <i th:class="${isPostLikedByUser} ? 'fas fa-heart' : 'far fa-heart'"></i>
                            <span th:id="'like-count-' + ${post.id}" th:text="${post.likeCount}">0</span>
                        </button>
                    </form>
                    <form class="dislike-post-form inline" th:data-post-id="${post.id}">
                        <button type="submit"
                                class="flex items-center space-x-2 px-4 py-2 rounded-xl font-semibold transition-all"
                                th:classappend="${isPostDislikedByUser} ? 'bg-blue-50 text-blue-600 hover:bg-blue-100' : 'bg-gray-100 text-gray-700 hover:bg-blue-50 hover:text-blue-600'">
                            <i th:class="${isPostDislikedByUser} ? 'fas fa-thumbs-down' : 'far fa-thumbs-down'"></i>
                            <span th:id="'dislike-count-' + ${post.id}" th:text="${post.dislikeCount}">0</span>
                        </button>
                    </form>
                    <button class="flex items-center space-x-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-xl font-semibold hover:bg-gray-200 transition-all">
                        <i class="far fa-comment"></i><span th:text="${post.commentCount}">0</span>
                    </button>
                    <a th:if="${user != null && user.id == post.author.id}" th:href="@{/posts/{id}/edit(id=${post.id})}"
                       class="px-4 py-2 rounded-lg transition hover:cursor-pointer bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-700">
                        <i class="fa-solid fa-pencil"></i>
                    </a>
                </div>

                <div class="flex items-center space-x-3">
                    <button onclick="shareOnFacebook()"
                            class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-md transition-all">
                        <i class="fab fa-facebook-f"></i>
                    </button>
                    <button class="px-3 py-1 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all"
                            title="Bookmark">
                        <i class="far fa-bookmark"></i>
                    </button>
                </div>
            </div>
        </div>
    </article>

    <!-- ðŸ’¬ Comments -->
    <div th:if="${user != null && post.allowComment}"
         class="bg-white rounded-2xl shadow-xl p-8 animate-fade-in-up delay-100">
        <h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fas fa-comments text-indigo-600 mr-2"></i>Comments
        </h2>

        <form class="add-comment-form mb-8" th:data-post-id="${post.id}">
            <div class="flex space-x-4">
                <img th:src="${user.avatarUrl}" th:alt="${user.fullName}"
                     class="w-12 h-12 rounded-full border-2 border-indigo-100 object-cover">
                <div class="flex-1">
                    <label>
                        <textarea name="content" rows="3" placeholder="Add a comment..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 resize-none transition-all"></textarea>
                    </label>
                    <div class="flex justify-end mt-2">
                        <button type="submit"
                                class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold px-6 py-2 rounded-xl hover:from-indigo-700 hover:to-purple-700 transform hover:scale-105 transition-all shadow-lg">
                            <i class="fas fa-paper-plane mr-2"></i>Post Comment
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <div class="space-y-6">
            <div th:each="commentView : ${comments}" class="flex space-x-4">
                <img th:src="${commentView.comment.commenter.avatarUrl}"
                     th:alt="${commentView.comment.commenter.fullName}"
                     class="w-12 h-12 rounded-full border-2 border-gray-200 object-cover">
                <div class="flex-1">
                    <div class="bg-gray-50 rounded-2xl p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <a th:href="@{/users/{id}(id=${commentView.comment.commenter.id})}"
                               class="font-semibold text-gray-800 hover:text-indigo-600"
                               th:text="${commentView.comment.commenter.fullName}">Commenter</a>
                            <span class="text-sm text-gray-500"
                                  th:text="${#temporals.format(commentView.comment.createdAt, 'MMM dd, yyyy')}"></span>
                        </div>
                        <p class="text-gray-700" th:text="${commentView.comment.content}"></p>
                    </div>
                    <div class="flex space-x-4 mt-2 text-sm text-gray-500">
                        <button type="submit"
                                th:disabled="${commentView.comment.commenter.id == user.id}"
                                th:data-comment-id="${commentView.comment.id}"
                                th:id="'like-cmt-btn-' + ${commentView.comment.id}"
                                th:classappend="${commentView.liked} ? 'text-emerald-700' : 'text-gray-500 hover:text-emerald-600'"
                                class="hover:text-indigo-600 like-cmt-btn">
                            <i class="far fa-heart mr-1"></i>
                            <span th:id="'like-count-' + ${commentView.comment.id}"
                                  th:text="${commentView.comment.likeCount}">0</span>
                        </button>
                        <button type="submit"
                                th:disabled="${commentView.comment.commenter.id == user.id}"
                                th:data-comment-id="${commentView.comment.id}"
                                th:id="'dislike-cmt-btn-' + ${commentView.comment.id}"
                                th:classappend="${commentView.disliked} ? 'text-red-700' : 'text-gray-500 hover:text-red-600'"
                                class="hover:text-indigo-600 dislike-cmt-btn">
                            <i class="fa-solid fa-turn-down mr-1"></i>
                            <span th:id="'dislike-count-' + ${commentView.comment.id}"
                                  th:text="${commentView.comment.dislikeCount}">0</span>
                        </button>
                        <button class="hover:text-indigo-600"><i class="far fa-comment mr-1"></i>Reply</button>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(comments)}" class="text-center py-8">
            <i class="fas fa-comments text-gray-300 text-5xl mb-3"></i>
            <p class="text-gray-500">No comments yet. Be the first!</p>
        </div>
    </div>

    <!-- ðŸ”— Related Posts -->
    <div th:if="${relatedPosts.size() > 0}" class="animate-fade-in-up delay-200">
        <h2 class="text-2xl font-bold text-gray-800 mb-6"><i class="fas fa-layer-group text-indigo-600 mr-2"></i>Related
            Posts</h2>
        <div class="grid md:grid-cols-2 gap-6">
            <div th:each="relatedPost : ${relatedPosts}"
                 class="bg-white rounded-2xl shadow-lg overflow-hidden hover-lift">
                <div class="flex">
                    <div class="w-32 h-32 bg-gradient-to-br from-indigo-400 to-purple-500 flex-shrink-0">
                        <img th:if="${relatedPost.thumbnailUrl}" th:src="${relatedPost.thumbnailUrl}"
                             class="w-full h-full object-cover" alt="">
                    </div>
                    <div class="p-4 flex-1">
                        <h3 class="font-bold text-gray-800 mb-2 hover:text-indigo-600 transition-colors line-clamp-2">
                            <a th:href="@{'/posts/' + ${relatedPost.id}}" th:text="${relatedPost.title}">Related</a>
                        </h3>
                        <div class="flex text-sm text-gray-500 space-x-2">
                            <span th:text="${relatedPost.author.fullName}">Author</span>
                            <span>â€¢</span>
                            <span th:text="${#temporals.format(relatedPost.createdAt, 'MMM dd')}">Date</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div th:if="${totalRelatedPosts > 4}" class="text-center mt-8">
            <a th:href="@{/posts}" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-lg transition">
                See More Related Posts
            </a>
        </div>
    </div>

    <!-- ðŸ§­ Table of Contents -->
    <aside class="bg-white rounded-2xl shadow-lg p-6 sticky top-10">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Table of Contents</h3>
        <nav id="table-of-contents" class="space-y-2"></nav>
    </aside>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    // build Table of Contents
    document.addEventListener('DOMContentLoaded', () => {
        const tocContainer = document.getElementById('table-of-contents');
        const headings = document.querySelectorAll('.prose h1, .prose h2, .prose h3');
        tocContainer.innerHTML = '';
        headings.forEach((h, i) => {
            h.id = 'heading-' + i;
            const a = document.createElement('a');
            a.href = '#' + h.id;
            a.textContent = h.textContent;
            a.className = 'block text-sm text-gray-600 hover:text-indigo-600 transition-colors';
            tocContainer.appendChild(a);
        });

        if (tocContainer.children.length === 0) {
            tocContainer.innerHTML = '<p class="text-gray-400 text-sm">No headings available</p>';
        }
    });

    function shareOnFacebook() {
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent(document.title);
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&t=${title}`,
            'facebook-share', 'width=580,height=296');
    }
</script>
</body>
</html>
